<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Player with Enhanced Debugging</title>
    <style>
        /* (CSS is unchanged from the previous, correct version to maintain UI stability) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding-bottom: 200px;
        }
        #container {
            background-color: #fff;
            padding: 20px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 720px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        #videoUrl {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            font-size: 16px;
        }
        button, select {
            padding: 10px 15px;
            border-radius: 6px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            background-color: #e4e6eb;
            font-weight: bold;
            color: #4b4f56;
            transition: background-color 0.2s;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        #loadBtn {
            background-color: #1877f2;
            color: #fff;
        }
        #loadBtn:hover { background-color: #166fe5; }
        button:hover:not(:disabled), select:hover { background-color: #d8dade; }
        #player-wrapper {
            background-color: #000;
            margin-bottom: 15px;
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
        }
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* --- UI FIX: VERTICAL STACK FOR CONTROL GROUPS --- */
        #controls {
            display: flex;
            flex-direction: column; /* Stack the groups vertically */
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        #scrub-controls, #playback-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }

        #status {
            width: 100%;
            margin-top: 15px;
            font-style: italic;
            color: #606770;
        }

        /* --- DEV CONSOLE STYLES --- */
        #dev-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background-color: #1e1e1e;
            border-top: 2px solid #555;
            display: none; /* Initially hidden */
            flex-direction: column;
            z-index: 9999;
        }
        #console-header {
            background-color: #333;
            padding: 4px 10px;
            font-family: monospace;
            color: #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #console-header button {
            font-size: 12px;
            padding: 2px 8px;
            background-color: #e4e6eb;
        }
        #console-output {
            flex-grow: 1;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 14px;
            padding: 8px;
            color: #ddd;
        }
        .console-message {
             padding: 2px 0;
             border-bottom: 1px solid #2a2a2a;
             white-space: pre-wrap;
        }
        .console-error { color: #ff8080; }
        .console-warn { color: #f2c76e; }
        .console-info { color: #78dce8; }
        .console-log { color: #aeffaeff; }
    </style>
</head>
<body>

    <div id="container">
        <h1>YouTube Player with Enhanced Debugging üõ†Ô∏è</h1>
        <div id="input-area">
            <input type="text" id="videoUrl" placeholder="Enter YouTube URL">
            <button id="loadBtn">Load Video</button>
        </div>

        <div id="player-wrapper">
             <div id="player"></div>
        </div>

        <div id="controls">
            <div id="scrub-controls">
                <button id="scrubBackBtn" title="Frame Back">‚óÄ Frame</button>
                <button id="scrubFwdBtn" title="Frame Forward">Frame ‚ñ∂</button>
            </div>
            <div id="playback-controls">
                <button id="playPauseBtn">Play</button>
                <select id="qualitySelector" title="Select video quality">
                    <option value="">--Quality--</option>
                </select>
            </div>
        </div>
        <p id="status">Status: Waiting for URL.</p>
    </div>

    <div id="dev-console">
        <div id="console-header">
            <span>Developer Console (Toggle with ` key)</span>
            <button id="clear-console-btn">Clear</button>
        </div>
        <div id="console-output"></div>
    </div>

    <script>
        // --- DEV CONSOLE SETUP (Unchanged from previous version) ---
        const devConsole = document.getElementById('dev-console');
        const consoleOutput = document.getElementById('console-output');
        const clearConsoleBtn = document.getElementById('clear-console-btn');

        window.addEventListener('keydown', (e) => {
            if (e.key === '`') {
                e.preventDefault();
                const isHidden = devConsole.style.display === 'none';
                devConsole.style.display = isHidden ? 'flex' : 'none';
                if (isHidden) { console.log('Dev console opened.'); } else { console.log('Dev console closed.'); }
            }
        });
        clearConsoleBtn.addEventListener('click', () => { consoleOutput.innerHTML = ''; console.log('Console output cleared.'); });

        (function () {
            const original = { log: console.log, error: console.error, warn: console.warn, info: console.info };
            function logToScreen(level, args) {
                const message = document.createElement('div');
                message.className = `console-message console-${level}`;
                const timestamp = new Date().toLocaleTimeString();
                const content = `[${timestamp}] ${args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ')}`;
                message.textContent = content;
                consoleOutput.appendChild(message);
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
            console.log = function(...args) { original.log.apply(console, args); logToScreen('log', args); };
            console.error = function(...args) { original.error.apply(console, args); logToScreen('error', args); };
            console.warn = function(...args) { original.warn.apply(console, args); logToScreen('warn', args); };
            console.info = function(...args) { original.info.apply(console, args); logToScreen('info', args); };
        })();


        // --- YOUTUBE PLAYER LOGIC ---
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        let player = null;
        const FRAME_RATE = 30;

        const playPauseBtn = document.getElementById('playPauseBtn');
        const qualitySelector = document.getElementById('qualitySelector');
        const loadBtn = document.getElementById('loadBtn');
        const videoUrlInput = document.getElementById('videoUrl');
        const statusEl = document.getElementById('status');
        const scrubBackBtn = document.getElementById('scrubBackBtn');
        const scrubFwdBtn = document.getElementById('scrubFwdBtn');

        const qualityLabels = {
            'hd2160': '4K (2160p)', 'hd1440': '1440p', 'hd1080': '1080p',
            'hd720': '720p', 'large': '480p', 'medium': '360p',
            'small': '240p', 'tiny': '144p', 'auto': 'Auto'
        };

        window.onYouTubeIframeAPIReady = function() {
            statusEl.textContent = 'Status: API ready. Enter a video URL.';
            console.info('YouTube IFrame API is ready.');
            loadBtn.disabled = false;
        };

        function extractVideoID(url) {
            const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regex);
            if (match && match[1]) { return match[1]; }
            return null;
        }

        function loadVideo() {
            const videoId = extractVideoID(videoUrlInput.value);
            if (!videoId) {
                statusEl.textContent = 'Status: Invalid URL. Please try again. ‚ùå';
                console.error('Invalid URL provided.');
                return;
            }

            statusEl.textContent = 'Status: Loading video...';
            console.log(`[Load] Creating YouTube player for video ID: ${videoId}`);

            if (player) {
                player.destroy();
                player = null;
            }

            const wrapper = document.getElementById('player-wrapper');
            let playerEl = document.getElementById('player');
            if (!playerEl) {
                playerEl = document.createElement('div');
                playerEl.id = 'player';
                wrapper.appendChild(playerEl);
                console.log('[Load] Recreated #player div in DOM.');
            }

            player = new YT.Player('player', {
                height: '390', width: '640', videoId: videoId,
                playerVars: { 'playsinline': 1, 'controls': 0, 'rel': 0 },
                events: {
                    'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange, 'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            console.log('--- ENTERING onPlayerReady ---');

            // 1. Update Status
            statusEl.textContent = 'Status: Video loaded successfully! ‚úÖ';
            console.info('Step 1: Status updated successfully.');

            // 2. Enable Controls
            // This is the critical step that might be failing.
            if (playPauseBtn && qualitySelector && scrubBackBtn && scrubFwdBtn) {
                playPauseBtn.disabled = false;
                qualitySelector.disabled = false;
                scrubBackBtn.disabled = false;
                scrubFwdBtn.disabled = false;
                console.log('Step 2: Controls enabled successfully.');
            } else {
                console.error('Step 2: FAILED to find one or more control buttons in the DOM.');
                return; // Exit if controls are missing
            }


            // 3. Populate quality selector
            try {
                const availableQualities = event.target.getAvailableQualityLevels() || [];
                const qualitiesWithOptions = ['auto', ...availableQualities];

                qualitySelector.innerHTML = '';
                qualitiesWithOptions.forEach(q => {
                    const option = document.createElement('option');
                    option.value = q;
                    option.textContent = qualityLabels[q] || q;
                    qualitySelector.appendChild(option);
                });
                console.log('Step 3: Quality selector populated successfully. Qualities:', qualitiesWithOptions);

            } catch (e) {
                console.error('Step 3: FAILED to populate quality selector.', e);
                // The rest of the function should still run even if this fails.
            }

            // 4. Start Video
            event.target.playVideo();
            console.log('Step 4: Called playVideo().');
            
            console.log('--- EXITING onPlayerReady SUCCESSFULLY ---');
        }

        function onPlayerStateChange(event) {
            const stateMap = { '-1': 'Unstarted', '0': 'Ended', '1': 'Playing', '2': 'Paused', '3': 'Buffering', '5': 'Cued' };
            const state = event.data;
            console.log(`[State] Changed to: ${state} (${stateMap[state] || 'Unknown'})`);

            if (state === YT.PlayerState.PLAYING) {
                playPauseBtn.textContent = 'Pause';
            } else {
                playPauseBtn.textContent = 'Play';
            }
        }

        function onPlayerError(event) {
            statusEl.textContent = `Status: An error occurred. Code: ${event.data} ‚ùå`;
            console.error(`[Error] Code: ${event.data}.`);
        }

        // --- Custom Control Event Listeners ---
        loadBtn.addEventListener('click', loadVideo);

        playPauseBtn.addEventListener('click', () => {
            if (!player || typeof player.getPlayerState !== 'function') return;
            const playerState = player.getPlayerState();
            console.log('[Control] Play/Pause clicked. Current state:', playerState);
            if (playerState === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        });

        qualitySelector.addEventListener('change', () => {
            if (!player || typeof player.setPlaybackQuality !== 'function') return;
            console.log('[Control] Quality changed to:', qualitySelector.value);
            player.setPlaybackQuality(qualitySelector.value);
        });

        scrubFwdBtn.addEventListener('click', () => {
            if (!player || typeof player.seekTo !== 'function') return;
            const currentTime = player.getCurrentTime();
            const newTime = currentTime + (1 / FRAME_RATE);
            console.log(`[Control] Scrub forward: ${currentTime.toFixed(3)}s -> ${newTime.toFixed(3)}s`);
            player.pauseVideo();
            player.seekTo(newTime, true);
        });

        scrubBackBtn.addEventListener('click', () => {
            if (!player || typeof player.seekTo !== 'function') return;
            const currentTime = player.getCurrentTime();
            const newTime = Math.max(0, currentTime - (1 / FRAME_RATE));
            console.log(`[Control] Scrub backward: ${currentTime.toFixed(3)}s -> ${newTime.toFixed(3)}s`);
            player.pauseVideo();
            player.seekTo(newTime, true);
        });

        function setInitialState() {
            console.log('Script initialized, setting initial state.');
            statusEl.textContent = 'Status: API is loading...';
            loadBtn.disabled = true;
            playPauseBtn.disabled = true;
            qualitySelector.disabled = true;
            scrubBackBtn.disabled = true;
            scrubFwdBtn.disabled = true;
        }
        setInitialState();
    </script>
</body>
</html>
