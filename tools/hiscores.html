<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scapewatch Hiscores</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .hiscores-container {
            background: #2c2416;
            border: 2px solid #5a4a3a;
            border-radius: 5px;
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            max-height: 900px;
            display: flex;
            flex-direction: column;
        }

        .hiscores-header {
            padding: 20px;
            background: #3a2a1a;
            border-bottom: 2px solid #5a4a3a;
            text-align: center;
        }

        .hiscores-header h1 {
            color: #f39c12;
            font-size: 36px;
        }

        .hiscores-layout {
            display: flex;
            height: 100%;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        .hiscores-categories {
            width: 200px;
            background: #1a1611;
            border: 1px solid #3a3025;
            padding: 10px;
            overflow-y: auto;
        }

        .hiscores-leaderboard {
            flex: 1;
            background: #1a1611;
            border: 1px solid #3a3025;
            padding: 20px;
            overflow-y: auto;
        }

        .hiscores-controls {
            width: 250px;
            background: #1a1611;
            border: 1px solid #3a3025;
            padding: 10px;
        }

        .hiscores-title {
            color: #f39c12;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .hiscores-category-item {
            padding: 8px;
            margin: 2px 0;
            cursor: pointer;
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 5px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .hiscores-category-item:hover {
            background: #2a2015;
        }

        .hiscores-category-item.active {
            background: #3a2520;
            color: #f39c12;
        }

        .category-icon {
            width: 20px;
            height: 20px;
        }

        .hiscores-leaderboard-title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .hiscores-title-icon {
            width: 32px;
            height: 32px;
            vertical-align: middle;
        }

        .hiscores-leaderboard-title {
            color: #f39c12;
            text-align: center;
            font-size: 24px;
        }

        .hiscores-table {
            width: 100%;
            border-collapse: collapse;
            color: #ccc;
        }

        .hiscores-table th {
            background: #2a2015;
            padding: 10px;
            text-align: left;
            color: #f39c12;
        }

        .hiscores-table td {
            padding: 8px;
            border-bottom: 1px solid #2a2015;
        }

        .hiscores-table tr:hover {
            background: #2a2015;
        }

        .hiscores-own-rank {
            background: #3a2520;
        }

        .hiscores-highlight {
            background: #4a3530 !important;
        }

        .hiscores-name {
            color: #5DADE2;
            cursor: pointer;
        }

        .hiscores-name:hover {
            text-decoration: underline;
        }

        .hiscores-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .hiscores-pagination button {
            padding: 5px 15px;
            background: #3a2520;
            border: 1px solid #5a4a3a;
            color: #ccc;
            cursor: pointer;
            border-radius: 3px;
        }

        .hiscores-pagination button:hover {
            background: #4a3530;
        }

        .hiscores-search-section {
            margin-bottom: 20px;
        }

        .hiscores-search-section label {
            display: block;
            color: #f39c12;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .hiscores-search-input {
            width: 100%;
            padding: 5px;
            background: #2a2015;
            border: 1px solid #3a3025;
            color: #ccc;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        .hiscores-search-btn {
            width: 100%;
            padding: 5px;
            background: #3a2520;
            border: 1px solid #5a4a3a;
            color: #ccc;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .hiscores-search-btn:hover {
            background: #4a3530;
        }

        .hiscores-your-rank-btn {
            width: 100%;
            padding: 10px;
            background: #f39c12;
            border: none;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .hiscores-your-rank-btn:hover {
            background: #e67e22;
        }

        .hiscores-back-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: #3a2520;
            border: 1px solid #5a4a3a;
            color: #ccc;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .hiscores-back-btn:hover {
            background: #4a3530;
        }

        .hiscores-skill-name-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hiscores-inline-icon {
            width: 20px;
            height: 20px;
        }

        .hiscores-compare-table {
            width: 100%;
            border-collapse: collapse;
            color: #ccc;
            margin-bottom: 20px;
        }

        .hiscores-compare-table th {
            background: #2a2015;
            padding: 10px;
            text-align: left;
            color: #f39c12;
            font-size: 16px;
        }

        .hiscores-subheader th {
            background: #221a10;
            font-size: 14px;
            color: #999;
            padding: 5px 10px;
        }

        .hiscores-compare-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #2a2015;
            font-size: 14px;
        }

        .hiscores-compare-rank {
            font-weight: bold;
            min-width: 60px;
        }

        .hiscores-compare-value {
            min-width: 80px;
        }

        .hiscores-compare-winner {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        .hiscores-loading,
        .hiscores-error {
            text-align: center;
            padding: 50px;
            color: #ccc;
            font-size: 18px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Loading screen */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
        }

        .loading-content h2 {
            color: #f39c12;
            margin-bottom: 20px;
        }

        .loading-spinner {
            border: 3px solid #333;
            border-top: 3px solid #f39c12;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <h2>Loading Hiscores...</h2>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="hiscores-container">
        <div class="hiscores-header">
            <h1>Scapewatch Hiscores</h1>
        </div>
        
        <div class="hiscores-layout">
            <!-- Categories -->
            <div class="hiscores-categories" id="hiscores-categories">
                <h3 class="hiscores-title">Categories</h3>
            </div>
            
            <!-- Leaderboard -->
            <div class="hiscores-leaderboard" id="hiscores-leaderboard">
                <div class="hiscores-loading">Select a category to view hiscores</div>
            </div>
            
            <!-- Controls -->
            <div class="hiscores-controls" id="hiscores-controls">
                <h3 class="hiscores-title">Search</h3>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDNTjUANEOUzcx13IhqZAT-grfMNPL8ia8",
            authDomain: "scapewatch-f2d9d.firebaseapp.com",
            projectId: "scapewatch-f2d9d",
            storageBucket: "scapewatch-f2d9d.firebasestorage.app",
            messagingSenderId: "631909394106",
            appId: "1:631909394106:web:86cf7b0a7d97675216c483",
            measurementId: "G-HJFKPL6N2B"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Skill data
        const skills = {
            'woodcutting': { name: 'Woodcutting' },
            'mining': { name: 'Mining' },
            'fishing': { name: 'Fishing' },
            'cooking': { name: 'Cooking' },
            'agility': { name: 'Agility' },
            'sailing': { name: 'Sailing' },
            'firemaking': { name: 'Firemaking' },
            'thieving': { name: 'Thieving' },
            'runecraft': { name: 'Runecraft' },
            'smithing': { name: 'Smithing' },
            'fletching': { name: 'Fletching' },
            'crafting': { name: 'Crafting' },
            'construction': { name: 'Construction' },
            'herblore': { name: 'Herblore' },
            'farming': { name: 'Farming' },
            'hunter': { name: 'Hunter' },
            'attack': { name: 'Attack' },
            'strength': { name: 'Strength' },
            'defence': { name: 'Defence' },
            'ranged': { name: 'Ranged' },
            'prayer': { name: 'Prayer' },
            'magic': { name: 'Magic' },
            'hitpoints': { name: 'Hitpoints' },
            'slayer': { name: 'Slayer' }
        };

        // Simple asset loader
        const assets = {};
        
        async function loadAssets() {
            const assetList = [
                { key: 'skill_skills', path: '../assets/skills/skills.png' },
                { key: 'ui_tasks', path: '../assets/ui/tasks.png' },
                { key: 'ui_pets', path: '../assets/ui/pets.png' },
                { key: 'ui_pets_shiny', path: '../assets/ui/pets(s).png' }
            ];

            // Add all skill icons
            for (const skillId of Object.keys(skills)) {
                assetList.push({
                    key: `skill_${skillId}`,
                    path: `../assets/skills/${skillId}.png`
                });
            }

            // Load all assets
            const promises = assetList.map(asset => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        assets[asset.key] = img.src;
                        resolve();
                    };
                    img.onerror = () => {
                        console.warn(`Failed to load: ${asset.path}`);
                        resolve();
                    };
                    img.src = asset.path;
                });
            });

            await Promise.all(promises);
        }

        // Hiscores Manager
        class HiscoresManager {
            constructor() {
                this.currentCategory = 'overall';
                this.currentPage = 0;
                this.pageSize = 25;
                this.SENTINEL_DATE = new Date('2099-12-31T23:59:59Z');
            }

            initialize() {
                this.renderCategories();
                this.renderControls();
                this.loadCategory('overall');
            }

            renderCategories() {
                const container = document.getElementById('hiscores-categories');
                const list = document.createElement('div');
                
                const categories = [
                    { id: 'overall', name: 'Overall', icon: 'skill_skills' }
                ];

                // Add all skills
                for (const [skillId, skillData] of Object.entries(skills)) {
                    categories.push({
                        id: `skill_${skillId}`,
                        name: skillData.name,
                        icon: `skill_${skillId}`
                    });
                }

                // Add other categories
                categories.push(
                    { id: 'tasks', name: 'Tasks', icon: 'ui_tasks' },
                    { id: 'pets', name: 'Pets', icon: 'ui_pets' },
                    { id: 'shinyPets', name: 'Shiny Pets', icon: 'ui_pets_shiny' }
                );

                categories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'hiscores-category-item';
                    if (this.currentCategory === cat.id) {
                        item.classList.add('active');
                    }

                    if (assets[cat.icon]) {
                        const icon = document.createElement('img');
                        icon.src = assets[cat.icon];
                        icon.className = 'category-icon';
                        item.appendChild(icon);
                    }

                    const text = document.createElement('span');
                    text.textContent = cat.name;
                    item.appendChild(text);

                    item.addEventListener('click', () => {
                        this.loadCategory(cat.id);
                    });

                    list.appendChild(item);
                });

                container.appendChild(list);
            }

            renderControls() {
                const container = document.getElementById('hiscores-controls');
                
                // Search by name
                const nameSearch = document.createElement('div');
                nameSearch.className = 'hiscores-search-section';
                
                const nameLabel = document.createElement('label');
                nameLabel.textContent = 'Search by name';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'hiscores-search-input';
                nameInput.placeholder = 'Username';
                nameInput.id = 'search-name';
                
                const nameBtn = document.createElement('button');
                nameBtn.className = 'hiscores-search-btn';
                nameBtn.textContent = 'Search';
                nameBtn.addEventListener('click', () => {
                    this.searchByName(nameInput.value);
                });
                
                nameSearch.appendChild(nameLabel);
                nameSearch.appendChild(nameInput);
                nameSearch.appendChild(nameBtn);
                
                // Search by rank
                const rankSearch = document.createElement('div');
                rankSearch.className = 'hiscores-search-section';
                
                const rankLabel = document.createElement('label');
                rankLabel.textContent = 'Search by rank';
                
                const rankInput = document.createElement('input');
                rankInput.type = 'number';
                rankInput.className = 'hiscores-search-input';
                rankInput.placeholder = 'Rank';
                rankInput.min = '1';
                rankInput.id = 'search-rank';
                
                const rankBtn = document.createElement('button');
                rankBtn.className = 'hiscores-search-btn';
                rankBtn.textContent = 'Search';
                rankBtn.addEventListener('click', () => {
                    const rank = parseInt(rankInput.value);
                    if (rank > 0) {
                        this.searchByRank(rank);
                    }
                });
                
                rankSearch.appendChild(rankLabel);
                rankSearch.appendChild(rankInput);
                rankSearch.appendChild(rankBtn);
                
                // Compare users
                const compareSection = document.createElement('div');
                compareSection.className = 'hiscores-search-section';
                
                const compareLabel = document.createElement('label');
                compareLabel.textContent = 'Compare Users';
                
                const user1Input = document.createElement('input');
                user1Input.type = 'text';
                user1Input.className = 'hiscores-search-input';
                user1Input.placeholder = 'User 1';
                user1Input.id = 'compare-user1';
                
                const user2Input = document.createElement('input');
                user2Input.type = 'text';
                user2Input.className = 'hiscores-search-input';
                user2Input.placeholder = 'User 2';
                user2Input.id = 'compare-user2';
                
                const compareBtn = document.createElement('button');
                compareBtn.className = 'hiscores-search-btn';
                compareBtn.textContent = 'Compare';
                compareBtn.addEventListener('click', () => {
                    this.compareUsers(user1Input.value, user2Input.value);
                });
                
                compareSection.appendChild(compareLabel);
                compareSection.appendChild(user1Input);
                compareSection.appendChild(user2Input);
                compareSection.appendChild(compareBtn);
                
                container.appendChild(nameSearch);
                container.appendChild(rankSearch);
                container.appendChild(compareSection);
            }

            async loadCategory(categoryId) {
                this.currentCategory = categoryId;
                this.currentPage = 0;
                
                // Update active state
                document.querySelectorAll('.hiscores-category-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const categories = document.querySelectorAll('.hiscores-category-item');
                categories.forEach(item => {
                    const text = item.querySelector('span')?.textContent;
                    let itemCategoryId = null;
                    
                    if (text === 'Overall') itemCategoryId = 'overall';
                    else if (text === 'Tasks') itemCategoryId = 'tasks';
                    else if (text === 'Pets') itemCategoryId = 'pets';
                    else if (text === 'Shiny Pets') itemCategoryId = 'shinyPets';
                    else {
                        for (const [skillId, skillData] of Object.entries(skills)) {
                            if (skillData.name === text) {
                                itemCategoryId = `skill_${skillId}`;
                                break;
                            }
                        }
                    }
                    
                    if (itemCategoryId === categoryId) {
                        item.classList.add('active');
                    }
                });
                
                await this.loadLeaderboard();
            }

            async loadLeaderboard() {
                const container = document.getElementById('hiscores-leaderboard');
                container.innerHTML = '<div class="hiscores-loading">Loading...</div>';
                
                try {
                    const data = await this.fetchLeaderboardData(this.currentCategory, this.currentPage);
                    this.displayLeaderboard(data);
                } catch (error) {
                    console.error('Failed to load leaderboard:', error);
                    container.innerHTML = '<div class="hiscores-error">Failed to load leaderboard</div>';
                }
            }

            async fetchLeaderboardData(category, page) {
                const startAt = page * this.pageSize;
                let query = db.collection('hiscores');
                
                if (category === 'overall') {
                    query = query.orderBy('totalLevel', 'desc')
                                 .orderBy('totalXp', 'desc')
                                 .orderBy('totalLevelFirstReached', 'asc');
                } else if (category === 'tasks') {
                    query = query.orderBy('tasksCompleted', 'desc');
                } else if (category === 'pets') {
                    query = query.orderBy('petsTotal', 'desc');
                } else if (category === 'shinyPets') {
                    query = query.orderBy('petsShiny', 'desc');
                } else if (category.startsWith('skill_')) {
                    const skillId = category.replace('skill_', '');
                    query = query.orderBy(`level_${skillId}`, 'desc')
                                 .orderBy(`xp_${skillId}`, 'desc')
                                 .orderBy(`levelFirst_${skillId}`, 'asc');
                }
                
                query = query.limit(this.pageSize);
                
                if (startAt > 0) {
                    // For pagination, we'd need to track the last document
                    // For simplicity, we'll just show the first page
                }
                
                const snapshot = await query.get();
                return snapshot.docs.map((doc, index) => ({
                    rank: startAt + index + 1,
                    ...doc.data(),
                    uid: doc.id
                }));
            }

            displayLeaderboard(data) {
                const container = document.getElementById('hiscores-leaderboard');
                container.innerHTML = '';
                
                // Title
                const titleContainer = document.createElement('div');
                titleContainer.className = 'hiscores-leaderboard-title-container';

                const title = document.createElement('h2');
                title.className = 'hiscores-leaderboard-title';

                // Add icon
                let iconKey = null;
                if (this.currentCategory === 'overall') {
                    iconKey = 'skill_skills';
                } else if (this.currentCategory === 'tasks') {
                    iconKey = 'ui_tasks';
                } else if (this.currentCategory === 'pets') {
                    iconKey = 'ui_pets';
                } else if (this.currentCategory === 'shinyPets') {
                    iconKey = 'ui_pets_shiny';
                } else if (this.currentCategory.startsWith('skill_')) {
                    iconKey = this.currentCategory;
                }

                if (iconKey && assets[iconKey]) {
                    const iconImg = document.createElement('img');
                    iconImg.className = 'hiscores-title-icon';
                    iconImg.src = assets[iconKey];
                    titleContainer.appendChild(iconImg);
                }

                title.textContent = this.getLeaderboardTitle();
                titleContainer.appendChild(title);
                container.appendChild(titleContainer);
                
                // Table
                const table = document.createElement('table');
                table.className = 'hiscores-table';
                
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                if (this.currentCategory === 'overall' || this.currentCategory.startsWith('skill_')) {
                    headerRow.innerHTML = '<th>Rank</th><th>Name</th><th>Level</th><th>XP</th>';
                } else {
                    headerRow.innerHTML = '<th>Rank</th><th>Name</th><th>Score</th>';
                }
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                
                data.forEach(player => {
                    const row = document.createElement('tr');
                    
                    if (this.currentCategory === 'overall') {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${player.totalLevel}</td>
                            <td>${this.formatNumber(player.totalXp)}</td>
                        `;
                    } else if (this.currentCategory.startsWith('skill_')) {
                        const skillId = this.currentCategory.replace('skill_', '');
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${player[`level_${skillId}`] || 1}</td>
                            <td>${this.formatNumber(player[`xp_${skillId}`] || 0)}</td>
                        `;
                    } else if (this.currentCategory === 'tasks') {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${this.formatNumber(player.tasksCompleted || 0)}</td>
                        `;
                    } else if (this.currentCategory === 'pets') {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${player.petsTotal || 0}</td>
                        `;
                    } else if (this.currentCategory === 'shinyPets') {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${player.petsShiny || 0}</td>
                        `;
                    }
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                container.appendChild(table);
                
                // Add click handlers for names
                container.querySelectorAll('.hiscores-name').forEach(nameEl => {
                    nameEl.addEventListener('click', () => {
                        this.showPlayerStats(nameEl.textContent);
                    });
                });
                
                // Pagination
                const pagination = document.createElement('div');
                pagination.className = 'hiscores-pagination';
                
                if (this.currentPage > 0) {
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = '← Previous';
                    prevBtn.addEventListener('click', () => {
                        this.currentPage--;
                        this.loadLeaderboard();
                    });
                    pagination.appendChild(prevBtn);
                }
                
                const pageInfo = document.createElement('span');
                pageInfo.textContent = `Page ${this.currentPage + 1}`;
                pagination.appendChild(pageInfo);
                
                if (data.length === this.pageSize) {
                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = 'Next →';
                    nextBtn.addEventListener('click', () => {
                        this.currentPage++;
                        this.loadLeaderboard();
                    });
                    pagination.appendChild(nextBtn);
                }
                
                container.appendChild(pagination);
            }

            getLeaderboardTitle() {
                if (this.currentCategory === 'overall') return 'Overall Hiscores';
                if (this.currentCategory === 'tasks') return 'Tasks Hiscores';
                if (this.currentCategory === 'pets') return 'Pets Hiscores';
                if (this.currentCategory === 'shinyPets') return 'Shiny Pets Hiscores';
                if (this.currentCategory.startsWith('skill_')) {
                    const skillId = this.currentCategory.replace('skill_', '');
                    return `${skills[skillId].name} Hiscores`;
                }
                return 'Hiscores';
            }

            async searchByName(username) {
                if (!username) return;
                
                try {
                    const userQuery = await db.collection('hiscores')
                        .where('username', '==', username)
                        .limit(1)
                        .get();
                    
                    if (!userQuery.empty) {
                        this.showPlayerStats(username);
                    } else {
                        alert('Player not found');
                    }
                } catch (error) {
                    console.error('Failed to search player:', error);
                }
            }

            async searchByRank(rank) {
                this.currentPage = Math.floor((rank - 1) / this.pageSize);
                await this.loadLeaderboard();
                
                // Highlight the specific rank
                setTimeout(() => {
                    const rows = document.querySelectorAll('.hiscores-table tbody tr');
                    rows.forEach(row => {
                        const rankCell = row.cells[0];
                        if (parseInt(rankCell.textContent) === rank) {
                            row.classList.add('hiscores-highlight');
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }, 100);
            }

            async showPlayerStats(username) {
                const container = document.getElementById('hiscores-leaderboard');
                container.innerHTML = '<div class="hiscores-loading">Loading player stats...</div>';
                
                try {
                    const userQuery = await db.collection('hiscores')
                        .where('username', '==', username)
                        .limit(1)
                        .get();
                    
                    if (userQuery.empty) {
                        container.innerHTML = '<div class="hiscores-error">Player not found</div>';
                        return;
                    }
                    
                    const userData = userQuery.docs[0].data();
                    const uid = userQuery.docs[0].id;
                    
                    container.innerHTML = '';
                    
                    // Title
                    const title = document.createElement('h2');
                    title.className = 'hiscores-leaderboard-title';
                    title.textContent = `Personal Hiscores for ${username}`;
                    container.appendChild(title);
                    
                    // Skills table
                    const skillsTable = document.createElement('table');
                    skillsTable.className = 'hiscores-table';
                    
                    const skillsHead = document.createElement('thead');
                    skillsHead.innerHTML = '<tr><th>Skill</th><th>Rank</th><th>Level</th><th>XP</th></tr>';
                    skillsTable.appendChild(skillsHead);
                    
                    const skillsBody = document.createElement('tbody');
                    
                    // Overall
                    const overallRow = document.createElement('tr');
                    const overallNameCell = document.createElement('td');
                    overallNameCell.className = 'hiscores-skill-name-cell';

                    if (assets['skill_skills']) {
                        const iconImg = document.createElement('img');
                        iconImg.className = 'hiscores-inline-icon';
                        iconImg.src = assets['skill_skills'];
                        overallNameCell.appendChild(iconImg);
                    }
                    const overallText = document.createElement('span');
                    overallText.textContent = 'Overall';
                    overallNameCell.appendChild(overallText);

                    overallRow.appendChild(overallNameCell);
                    overallRow.innerHTML += `
                        <td>-</td>
                        <td>${userData.totalLevel}</td>
                        <td>${this.formatNumber(userData.totalXp)}</td>
                    `;
                    skillsBody.appendChild(overallRow);

                    // Individual skills
                    for (const [skillId, skillData] of Object.entries(skills)) {
                        const row = document.createElement('tr');
                        
                        const nameCell = document.createElement('td');
                        nameCell.className = 'hiscores-skill-name-cell';
                        
                        if (assets[`skill_${skillId}`]) {
                            const iconImg = document.createElement('img');
                            iconImg.className = 'hiscores-inline-icon';
                            iconImg.src = assets[`skill_${skillId}`];
                            nameCell.appendChild(iconImg);
                        }
                        const skillText = document.createElement('span');
                        skillText.textContent = skillData.name;
                        nameCell.appendChild(skillText);
                        
                        row.appendChild(nameCell);
                        row.innerHTML += `
                            <td>-</td>
                            <td>${userData[`level_${skillId}`] || 1}</td>
                            <td>${this.formatNumber(userData[`xp_${skillId}`] || 0)}</td>
                        `;
                        skillsBody.appendChild(row);
                    }
                    
                    skillsTable.appendChild(skillsBody);
                    container.appendChild(skillsTable);
                    
                    // Categories table
                    const catTable = document.createElement('table');
                    catTable.className = 'hiscores-table';
                    
                    const catHead = document.createElement('thead');
                    catHead.innerHTML = '<tr><th>Category</th><th>Rank</th><th>Score</th></tr>';
                    catTable.appendChild(catHead);
                    
                    const catBody = document.createElement('tbody');
                    
                    // Tasks
                    const tasksRow = document.createElement('tr');
                    const tasksNameCell = document.createElement('td');
                    tasksNameCell.className = 'hiscores-skill-name-cell';

                    if (assets['ui_tasks']) {
                        const iconImg = document.createElement('img');
                        iconImg.className = 'hiscores-inline-icon';
                        iconImg.src = assets['ui_tasks'];
                        tasksNameCell.appendChild(iconImg);
                    }
                    const tasksText = document.createElement('span');
                    tasksText.textContent = 'Tasks';
                    tasksNameCell.appendChild(tasksText);

                    tasksRow.appendChild(tasksNameCell);
                    tasksRow.innerHTML += `
                        <td>-</td>
                        <td>${this.formatNumber(userData.tasksCompleted || 0)}</td>
                    `;
                    catBody.appendChild(tasksRow);

                    // Pets
                    const petsRow = document.createElement('tr');
                    const petsNameCell = document.createElement('td');
                    petsNameCell.className = 'hiscores-skill-name-cell';

                    if (assets['ui_pets']) {
                        const iconImg = document.createElement('img');
                        iconImg.className = 'hiscores-inline-icon';
                        iconImg.src = assets['ui_pets'];
                        petsNameCell.appendChild(iconImg);
                    }
                    const petsText = document.createElement('span');
                    petsText.textContent = 'Pets';
                    petsNameCell.appendChild(petsText);

                    petsRow.appendChild(petsNameCell);
                    petsRow.innerHTML += `
                        <td>-</td>
                        <td>${userData.petsTotal || 0}</td>
                    `;
                    catBody.appendChild(petsRow);

                    // Shiny Pets
                    const shinyRow = document.createElement('tr');
                    const shinyNameCell = document.createElement('td');
                    shinyNameCell.className = 'hiscores-skill-name-cell';

                    if (assets['ui_pets_shiny']) {
                        const iconImg = document.createElement('img');
                        iconImg.className = 'hiscores-inline-icon';
                        iconImg.src = assets['ui_pets_shiny'];
                        shinyNameCell.appendChild(iconImg);
                    }
                    const shinyText = document.createElement('span');
                    shinyText.textContent = 'Shiny Pets';
                    shinyNameCell.appendChild(shinyText);

                    shinyRow.appendChild(shinyNameCell);
                    shinyRow.innerHTML += `
                        <td>-</td>
                        <td>${userData.petsShiny || 0}</td>
                    `;
                    catBody.appendChild(shinyRow);
                    
                    catTable.appendChild(catBody);
                    container.appendChild(catTable);
                    
                    // Back button
                    const backBtn = document.createElement('button');
                    backBtn.className = 'hiscores-back-btn';
                    backBtn.textContent = '← Back to Leaderboard';
                    backBtn.addEventListener('click', () => {
                        this.loadLeaderboard();
                    });
                    container.appendChild(backBtn);
                    
                } catch (error) {
                    console.error('Failed to load player stats:', error);
                    container.innerHTML = '<div class="hiscores-error">Failed to load player stats</div>';
                }
            }

            async compareUsers(user1, user2) {
                if (!user1 || !user2) {
                    alert('Please enter two usernames to compare');
                    return;
                }
                
                const container = document.getElementById('hiscores-leaderboard');
                container.innerHTML = '<div class="hiscores-loading">Loading comparison...</div>';
                
                try {
                    // Fetch both users
                    const user1Query = await db.collection('hiscores')
                        .where('username', '==', user1)
                        .limit(1)
                        .get();
                    
                    const user2Query = await db.collection('hiscores')
                        .where('username', '==', user2)
                        .limit(1)
                        .get();
                    
                    if (user1Query.empty || user2Query.empty) {
                        container.innerHTML = '<div class="hiscores-error">One or both players not found</div>';
                        return;
                    }
                    
                    const user1Data = user1Query.docs[0].data();
                    const user2Data = user2Query.docs[0].data();
                    
                    container.innerHTML = '';
                    
                    // Title
                    const title = document.createElement('h2');
                    title.className = 'hiscores-leaderboard-title';
                    title.textContent = `Comparing ${user1} vs ${user2}`;
                    container.appendChild(title);
                    
                    // Skills comparison table
                    const skillsTable = document.createElement('table');
                    skillsTable.className = 'hiscores-compare-table';
                    
                    const skillsHead = document.createElement('thead');
                    skillsHead.innerHTML = `
                        <tr>
                            <th>Skill</th>
                            <th colspan="2">${user1}</th>
                            <th colspan="2">${user2}</th>
                            <th>Winner</th>
                        </tr>
                        <tr class="hiscores-subheader">
                            <th></th>
                            <th>Level</th>
                            <th>XP</th>
                            <th>Level</th>
                            <th>XP</th>
                            <th></th>
                        </tr>
                    `;
                    skillsTable.appendChild(skillsHead);
                    
                    const skillsBody = document.createElement('tbody');
                    
                    // Add comparison rows for each skill
                    const addCompareRow = (label, iconKey, value1, xp1, value2, xp2) => {
                        const row = document.createElement('tr');
                        
                        const labelCell = document.createElement('td');
                        labelCell.className = 'hiscores-skill-name-cell';
                        
                        if (iconKey && assets[iconKey]) {
                            const iconImg = document.createElement('img');
                            iconImg.className = 'hiscores-inline-icon';
                            iconImg.src = assets[iconKey];
                            labelCell.appendChild(iconImg);
                        }
                        const labelText = document.createElement('span');
                        labelText.textContent = label;
                        labelCell.appendChild(labelText);
                        
                        const value1Cell = document.createElement('td');
                        value1Cell.textContent = value1;
                        
                        const xp1Cell = document.createElement('td');
                        xp1Cell.textContent = this.formatNumber(xp1);
                        
                        const value2Cell = document.createElement('td');
                        value2Cell.textContent = value2;
                        
                        const xp2Cell = document.createElement('td');
                        xp2Cell.textContent = this.formatNumber(xp2);
                        
                        const winnerCell = document.createElement('td');
                        winnerCell.className = 'hiscores-compare-winner';
                        
                        if (xp1 > xp2) {
                            winnerCell.textContent = '←';
                            winnerCell.style.color = '#2ecc71';
                            value1Cell.style.color = '#2ecc71';
                            xp1Cell.style.color = '#2ecc71';
                            value2Cell.style.color = '#e74c3c';
                            xp2Cell.style.color = '#e74c3c';
                        } else if (xp2 > xp1) {
                            winnerCell.textContent = '→';
                            winnerCell.style.color = '#2ecc71';
                            value2Cell.style.color = '#2ecc71';
                            xp2Cell.style.color = '#2ecc71';
                            value1Cell.style.color = '#e74c3c';
                            xp1Cell.style.color = '#e74c3c';
                        } else {
                            winnerCell.textContent = '=';
                            winnerCell.style.color = '#f39c12';
                        }
                        
                        row.appendChild(labelCell);
                        row.appendChild(value1Cell);
                        row.appendChild(xp1Cell);
                        row.appendChild(value2Cell);
                        row.appendChild(xp2Cell);
                        row.appendChild(winnerCell);
                        
                        skillsBody.appendChild(row);
                    };
                    
                    // Overall
                    addCompareRow('Overall', 'skill_skills', 
                        user1Data.totalLevel, user1Data.totalXp,
                        user2Data.totalLevel, user2Data.totalXp);
                    
                    // Individual skills
                    for (const [skillId, skillData] of Object.entries(skills)) {
                        addCompareRow(skillData.name, `skill_${skillId}`,
                            user1Data[`level_${skillId}`] || 1, user1Data[`xp_${skillId}`] || 0,
                            user2Data[`level_${skillId}`] || 1, user2Data[`xp_${skillId}`] || 0);
                    }
                    
                    skillsTable.appendChild(skillsBody);
                    container.appendChild(skillsTable);
                    
                    // Back button
                    const backBtn = document.createElement('button');
                    backBtn.className = 'hiscores-back-btn';
                    backBtn.textContent = '← Back to Leaderboard';
                    backBtn.addEventListener('click', () => {
                        this.loadLeaderboard();
                    });
                    container.appendChild(backBtn);
                    
                } catch (error) {
                    console.error('Failed to compare users:', error);
                    container.innerHTML = '<div class="hiscores-error">Failed to compare users</div>';
                }
            }

            formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
        }

        // Initialize
        async function init() {
            try {
                await loadAssets();
                const hiscores = new HiscoresManager();
                hiscores.initialize();
                
                // Hide loading overlay
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('loading-overlay').innerHTML = 
                    '<div class="loading-content"><h2>Failed to load hiscores</h2></div>';
            }
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>