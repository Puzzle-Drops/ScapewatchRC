<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scapewatch Hiscores</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules from CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFunctions, 
            httpsCallable 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
        import { 
            getFirestore
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Make Firebase Functions available globally
        window.firestoreHelpers = {
            httpsCallable
        };

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCYeL73i31Nv6k_ErSVMmENiOdSV_YlvRc",
            authDomain: "scapewatchrc.firebaseapp.com",
            projectId: "scapewatchrc",
            storageBucket: "scapewatchrc.firebasestorage.app",
            messagingSenderId: "648502226475",
            appId: "1:648502226475:web:5429698e1f50f41f51c46e",
            measurementId: "G-LX5LCFP77H"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        // Create minimal firebaseManager for hiScores.js
        window.firebaseManager = {
            db: db,
            functions: functions,
            currentUser: null,
            username: null,
            connectionHealthy: true
        };

        // Skills data
        const skillsData = {
            'attack': { name: 'Attack' },
            'strength': { name: 'Strength' },
            'defence': { name: 'Defence' },
            'hitpoints': { name: 'Hitpoints' },
            'ranged': { name: 'Ranged' },
            'magic': { name: 'Magic' },
            'prayer': { name: 'Prayer' },
            'woodcutting': { name: 'Woodcutting' },
            'mining': { name: 'Mining' },
            'fishing': { name: 'Fishing' },
            'cooking': { name: 'Cooking' },
            'crafting': { name: 'Crafting' },
            'smithing': { name: 'Smithing' },
            'agility': { name: 'Agility' },
            'thieving': { name: 'Thieving' },
            'runecraft': { name: 'Runecraft' },
            'hunter': { name: 'Hunter' },
            'farming': { name: 'Farming' },
            'slayer': { name: 'Slayer' },
            'herblore': { name: 'Herblore' },
            'fletching': { name: 'Fletching' },
            'construction': { name: 'Construction' },
            'firemaking': { name: 'Firemaking' },
            'sailing': { name: 'Sailing' }
        };

        // Create a simple LoadingManager for this tool
        class SimpleLoadingManager {
            constructor() {
                this.assets = {
                    images: {},
                    data: { skills: skillsData }
                };
                this.loadQueue = [];
                this.loaded = 0;
                this.total = 0;
            }

            addImage(key, path) {
                this.loadQueue.push({ type: 'image', key, path });
                this.total++;
            }

            loadImage(key, path) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        this.assets.images[key] = img;
                        this.loaded++;
                        resolve();
                    };
                    img.onerror = () => {
                        console.warn(`Failed to load image: ${path}`);
                        this.loaded++;
                        resolve(); // Continue even if image fails
                    };
                    img.src = path;
                });
            }

            async loadAll() {
                const promises = this.loadQueue.map(item => {
                    if (item.type === 'image') {
                        return this.loadImage(item.key, item.path);
                    }
                });
                await Promise.all(promises);
            }

            getImage(key) {
                return this.assets.images[key];
            }

            getData(key) {
                return this.assets.data[key];
            }
        }

        // Create loading manager instance
        const loadingManager = new SimpleLoadingManager();

        // Add all required images
        loadingManager.addImage('skill_skills', '../assets/skills/skills.png');
        loadingManager.addImage('ui_tasks', '../assets/ui/tasks.png');
        loadingManager.addImage('ui_pets', '../assets/ui/pets.png');
        loadingManager.addImage('ui_pets_shiny', '../assets/ui/pets(s).png');
        loadingManager.addImage('skill_combat', '../assets/skills/combat.png');
        
        // Add clue icons
        loadingManager.addImage('ui_all_clue', '../assets/ui/all_clue.png');
        loadingManager.addImage('items_easy_clue', '../assets/items/easy_clue.png');
        loadingManager.addImage('items_medium_clue', '../assets/items/medium_clue.png');
        loadingManager.addImage('items_hard_clue', '../assets/items/hard_clue.png');
        loadingManager.addImage('items_elite_clue', '../assets/items/elite_clue.png');
        loadingManager.addImage('items_master_clue', '../assets/items/master_clue.png');

        // Add all skill icons
        Object.keys(skillsData).forEach(skillId => {
            loadingManager.addImage(`skill_${skillId}`, `../assets/skills/${skillId}.png`);
        });

        // Make loadingManager available globally
        window.loadingManager = loadingManager;

        // Utility function
        window.formatNumber = function(num) {
            if (num === undefined || num === null) return '0';
            return num.toLocaleString();
        };

        // Import httpsCallable for Firebase Functions
        const { httpsCallable } = window.firestoreHelpers || {};

        // HiScores Manager using Firebase Cloud Functions
        class HiScoresManager {
            constructor() {
                this.isOpen = false;
                this.currentCategory = 'overall';
                this.currentPage = 0;
                this.pageSize = 25;
                // Client-side cache for leaderboard pages
                this.leaderboardCache = new Map(); // Stores { category: { page: data, timestamp: time } }
                this.clientCacheTimeout = 60 * 1000; // 1 minute client-side cache for leaderboard pages
                
                this.compareMode = false;
                this.compareUsers = [];
                this.lastUpdateTime = null; // From server metadata
                this.totalPlayers = 0;      // From server metadata
            }
            
            // Initialize the hi-scores system
            initialize() {
                this.setupEventListeners();
            }
            
            // Set up event listeners
            setupEventListeners() {
                // Close button
                const closeBtn = document.getElementById('hiscores-close-x');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.close());
                }
            }
            
            // Open the hi-scores modal
            open() {
                this.isOpen = true;
                const modal = document.getElementById('hiscores-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    this.render();
                    this.loadCategory('overall');
                }
            }
            
            // Close the hi-scores modal
            close() {
                this.isOpen = false;
                const modal = document.getElementById('hiscores-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
                this.compareMode = false;
                this.compareUsers = [];
                // Clear any specific display elements that might be lingering
                const leaderboardContainer = document.getElementById('hiscores-leaderboard');
                if (leaderboardContainer) {
                    leaderboardContainer.innerHTML = '';
                }
            }
            
            // Render the hi-scores UI
            render() {
                this.renderCategories();
                this.renderControls();
            }
            
            // Render the category list (left side)
            renderCategories() {
                const container = document.getElementById('hiscores-categories');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Title
                const title = document.createElement('h3');
                title.className = 'hiscores-title';
                title.textContent = 'Hiscores';
                container.appendChild(title);
                
                // Categories list - start with just Overall
                const categories = [
                    { id: 'overall', name: 'Overall', icon: 'skill_skills' }
                ];

                // Add all skills next
                const skillsData = window.loadingManager.getData('skills');
                for (const skillId of Object.keys(skillsData)) {
                    categories.push({
                        id: `skill_${skillId}`,
                        name: skillsData[skillId].name,
                        icon: `skill_${skillId}`
                    });
                }

                // Add Tasks, Pets, Shiny Pets, and Clues at the end
                categories.push(
                    { id: 'tasks', name: 'Tasks', icon: 'ui_tasks' },
                    { id: 'pets', name: 'Pets', icon: 'ui_pets' },
                    { id: 'shinyPets', name: 'Shiny Pets', icon: 'ui_pets_shiny' },
                    { id: 'cluesTotal', name: 'All Clues', icon: 'ui_all_clue' },
                    { id: 'clueseasy', name: 'Easy Clues', icon: 'items_easy_clue' },
                    { id: 'cluesmedium', name: 'Medium Clues', icon: 'items_medium_clue' },
                    { id: 'clueshard', name: 'Hard Clues', icon: 'items_hard_clue' },
                    { id: 'clueselite', name: 'Elite Clues', icon: 'items_elite_clue' },
                    { id: 'cluesmaster', name: 'Master Clues', icon: 'items_master_clue' }
                );
                
                const list = document.createElement('div');
                list.className = 'hiscores-category-list';
                
                categories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'hiscores-category-item';
                    if (this.currentCategory === cat.id) {
                        item.classList.add('active');
                    }
                    
                    // Add icon if available
                    if (cat.icon) {
                        const icon = window.loadingManager.getImage(cat.icon);
                        if (icon) {
                            const iconImg = document.createElement('img');
                            iconImg.src = icon.src;
                            iconImg.className = 'category-icon';
                            item.appendChild(iconImg);
                        }
                    }
                    
                    const text = document.createElement('span');
                    text.textContent = cat.name;
                    item.appendChild(text);
                    
                    item.addEventListener('click', () => {
                        this.loadCategory(cat.id);
                    });
                    
                    list.appendChild(item);
                });
                
                container.appendChild(list);
            }
            
            // Render the controls (right side)
            renderControls() {
                const container = document.getElementById('hiscores-controls');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Search by name
                const nameSearch = document.createElement('div');
                nameSearch.className = 'hiscores-search-section';
                
                const nameLabel = document.createElement('label');
                nameLabel.textContent = 'Search by name';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'hiscores-search-input';
                nameInput.placeholder = 'Username';
                
                const nameBtn = document.createElement('button');
                nameBtn.className = 'hiscores-search-btn';
                nameBtn.textContent = 'Search';
                nameBtn.addEventListener('click', () => {
                    this.searchByName(nameInput.value);
                });
                
                nameSearch.appendChild(nameLabel);
                nameSearch.appendChild(nameInput);
                nameSearch.appendChild(nameBtn);
                
                // Search by rank
                const rankSearch = document.createElement('div');
                rankSearch.className = 'hiscores-search-section';
                
                const rankLabel = document.createElement('label');
                rankLabel.textContent = 'Search by rank';
                
                const rankInput = document.createElement('input');
                rankInput.type = 'number';
                rankInput.className = 'hiscores-search-input';
                rankInput.placeholder = 'Rank';
                rankInput.min = '1';
                
                const rankBtn = document.createElement('button');
                rankBtn.className = 'hiscores-search-btn';
                rankBtn.textContent = 'Search';
                rankBtn.addEventListener('click', () => {
                    const rank = parseInt(rankInput.value);
                    if (rank > 0) {
                        this.searchByRank(rank);
                    }
                });
                
                rankSearch.appendChild(rankLabel);
                rankSearch.appendChild(rankInput);
                rankSearch.appendChild(rankBtn);
                
                // Compare users
                const compareSection = document.createElement('div');
                compareSection.className = 'hiscores-search-section';
                
                const compareLabel = document.createElement('label');
                compareLabel.textContent = 'Compare Users';
                
                const user1Input = document.createElement('input');
                user1Input.type = 'text';
                user1Input.className = 'hiscores-search-input';
                user1Input.placeholder = 'User 1';
                
                const user2Input = document.createElement('input');
                user2Input.type = 'text';
                user2Input.className = 'hiscores-search-input';
                user2Input.placeholder = 'User 2';
                
                const compareBtn = document.createElement('button');
                compareBtn.className = 'hiscores-search-btn';
                compareBtn.textContent = 'Compare';
                compareBtn.addEventListener('click', () => {
                    this.compareUsersDisplay(user1Input.value, user2Input.value);
                });
                
                compareSection.appendChild(compareLabel);
                compareSection.appendChild(user1Input);
                compareSection.appendChild(user2Input);
                compareSection.appendChild(compareBtn);
                
                container.appendChild(nameSearch);
                container.appendChild(rankSearch);
                container.appendChild(compareSection);
                
                // Your rank button
                const yourRankBtn = document.createElement('button');
                yourRankBtn.className = 'hiscores-your-rank-btn';
                yourRankBtn.textContent = 'View Your Rank';
                yourRankBtn.addEventListener('click', () => {
                    if (window.firebaseManager.username) {
                        this.searchByName(window.firebaseManager.username);
                    }
                });
                
                container.appendChild(yourRankBtn);
            }
            
            // Load a category
            async loadCategory(categoryId) {
                this.currentCategory = categoryId;
                this.currentPage = 0;
                this.compareMode = false;
                
                // Update active state in categories
                document.querySelectorAll('.hiscores-category-item').forEach((item, index) => {
                    item.classList.remove('active');
                    const text = item.querySelector('span')?.textContent;
                    
                    let itemCategoryId = null;
                    // Map text content back to category ID
                    switch (text) {
                        case 'Overall': itemCategoryId = 'overall'; break;
                        case 'Tasks': itemCategoryId = 'tasks'; break;
                        case 'Pets': itemCategoryId = 'pets'; break;
                        case 'Shiny Pets': itemCategoryId = 'shinyPets'; break;
                        case 'All Clues': itemCategoryId = 'cluesTotal'; break;
                        case 'Easy Clues': itemCategoryId = 'clueseasy'; break;
                        case 'Medium Clues': itemCategoryId = 'cluesmedium'; break;
                        case 'Hard Clues': itemCategoryId = 'clueshard'; break;
                        case 'Elite Clues': itemCategoryId = 'clueselite'; break;
                        case 'Master Clues': itemCategoryId = 'cluesmaster'; break;
                        default:
                            const skillsData = window.loadingManager.getData('skills');
                            for (const skillId of Object.keys(skillsData)) {
                                if (skillsData[skillId].name === text) {
                                    itemCategoryId = `skill_${skillId}`;
                                    break;
                                }
                            }
                    }
                    
                    if (itemCategoryId === categoryId) {
                        item.classList.add('active');
                    }
                });
                
                // Load and display data
                await this.loadLeaderboard();
            }
            
            // Load leaderboard data
            async loadLeaderboard() {
                const container = document.getElementById('hiscores-leaderboard');
                if (!container) return;
                
                // Show loading
                container.innerHTML = '<div class="hiscores-loading">Loading...</div>';
                
                try {
                    const data = await this.fetchLeaderboardData(this.currentCategory, this.currentPage);
                    this.displayLeaderboard(data);
                } catch (error) {
                    console.error('Failed to load leaderboard:', error);
                    container.innerHTML = '<div class="hiscores-error">Failed to load leaderboard</div>';
                }
            }
            
            // Fetch leaderboard data from Firebase Functions (uses client-side cache)
            async fetchLeaderboardData(category, page) {
                // Check client-side cache first
                const cacheKey = `${category}-${page}`;
                const cachedEntry = this.leaderboardCache.get(cacheKey);

                if (cachedEntry && (Date.now() - cachedEntry.timestamp < this.clientCacheTimeout)) {
                    console.log(`[HiScoresManager] Using client-side cache for ${cacheKey}`);
                    this.lastUpdateTime = cachedEntry.metadata.lastUpdated;
                    this.totalPlayers = cachedEntry.metadata.totalPlayers;
                    return cachedEntry.data;
                }

                try {
                    if (!window.firebaseManager.functions) {
                        console.error('Firebase Functions not initialized');
                        return [];
                    }
                    
                    const getHiscores = httpsCallable(window.firebaseManager.functions, 'getHiscores');
                    const result = await getHiscores({
                        category: category,
                        page: page,
                        pageSize: this.pageSize
                    });
                    
                    if (!result.data.success) {
                        console.error('Failed to fetch hiscores:', result.data.message);
                        return [];
                    }
                    
                    this.lastUpdateTime = result.data.metadata.lastUpdated;
                    this.totalPlayers = result.data.metadata.totalPlayers;
                    
                    // Store in client-side cache
                    this.leaderboardCache.set(cacheKey, {
                        data: result.data.data,
                        metadata: result.data.metadata,
                        timestamp: Date.now()
                    });

                    return result.data.data;
                    
                } catch (error) {
                    console.error('Failed to fetch leaderboard:', error);
                    if (error.code === 'functions/not-found') {
                        console.error('Hiscores function not deployed');
                    } else if (error.code === 'functions/permission-denied') {
                        console.error('Permission denied for hiscores access');
                    } else if (error.code === 'functions/unavailable') {
                        console.error('Firebase Functions temporarily unavailable');
                    }
                    return [];
                }
            }
            
            // Display leaderboard
            displayLeaderboard(data) {
                const container = document.getElementById('hiscores-leaderboard');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Title with icon
                const titleContainer = document.createElement('div');
                titleContainer.className = 'hiscores-leaderboard-title-container';

                const title = document.createElement('h2');
                title.className = 'hiscores-leaderboard-title';

                let iconKey = null;
                if (this.currentCategory === 'overall') { iconKey = 'skill_skills'; }
                else if (this.currentCategory === 'tasks') { iconKey = 'ui_tasks'; }
                else if (this.currentCategory === 'pets') { iconKey = 'ui_pets'; }
                else if (this.currentCategory === 'shinyPets') { iconKey = 'ui_pets_shiny'; }
                else if (this.currentCategory === 'cluesTotal') { iconKey = 'ui_all_clue'; }
                else if (this.currentCategory === 'clueseasy') { iconKey = 'items_easy_clue'; }
                else if (this.currentCategory === 'cluesmedium') { iconKey = 'items_medium_clue'; }
                else if (this.currentCategory === 'clueshard') { iconKey = 'items_hard_clue'; }
                else if (this.currentCategory === 'clueselite') { iconKey = 'items_elite_clue'; }
                else if (this.currentCategory === 'cluesmaster') { iconKey = 'items_master_clue'; }
                else if (this.currentCategory.startsWith('skill_')) { iconKey = this.currentCategory; }

                if (iconKey) {
                    const icon = window.loadingManager.getImage(iconKey);
                    if (icon) {
                        const iconImg = document.createElement('img');
                        iconImg.className = 'hiscores-title-icon';
                        iconImg.src = icon.src;
                        titleContainer.appendChild(iconImg);
                    }
                }

                title.textContent = this.getLeaderboardTitle();
                titleContainer.appendChild(title);
                container.appendChild(titleContainer);
                
                // Table
                const table = document.createElement('table');
                table.className = 'hiscores-table';
                
                // Header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                if (this.currentCategory === 'overall' || this.currentCategory.startsWith('skill_')) {
                    headerRow.innerHTML = '<th>Rank</th><th>Name</th><th>Level</th><th>XP</th>';
                } else {
                    headerRow.innerHTML = '<th>Rank</th><th>Name</th><th>Score</th>';
                }
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Body
                const tbody = document.createElement('tbody');
                
                data.forEach(player => {
                    const row = document.createElement('tr');
                    
                    if (player.uid === window.firebaseManager.currentUser?.uid) {
                        row.classList.add('hiscores-own-rank');
                    }
                    
                    // Map the lowercase category to the field name for clues
                    const clueFieldMap = {
                        'cluesTotal': 'cluesTotal', 'clueseasy': 'cluesEasy', 'cluesmedium': 'cluesMedium',
                        'clueshard': 'cluesHard', 'clueselite': 'cluesElite', 'cluesmaster': 'cluesMaster'
                    };
                    const clueField = clueFieldMap[this.currentCategory];

                    if (this.currentCategory === 'overall') {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${player.totalLevel}</td>
                            <td>${formatNumber(player.totalXp)}</td>
                        `;
                    } else if (this.currentCategory.startsWith('skill_')) {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${player.level || 1}</td>
                            <td>${formatNumber(player.xp || 0)}</td>
                        `;
                    } else if (this.currentCategory === 'tasks') {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${formatNumber(player.tasksCompleted || 0)}</td>
                        `;
                    } else if (this.currentCategory === 'pets') {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${player.petsTotal || 0}</td>
                        `;
                    } else if (this.currentCategory === 'shinyPets') {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${player.petsShiny || 0}</td>
                        `;
                    } else if (clueField) {
                        row.innerHTML = `
                            <td>${player.rank}</td>
                            <td class="hiscores-name" data-uid="${player.uid}">${player.username}</td>
                            <td>${player[clueField] || 0}</td>
                        `;
                    }
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                container.appendChild(table);
                
                // Add click handlers for names
                container.querySelectorAll('.hiscores-name').forEach(nameEl => {
                    nameEl.style.cursor = 'pointer';
                    nameEl.addEventListener('click', () => {
                        this.showPlayerStats(nameEl.textContent);
                    });
                });
                
                // Pagination
                const pagination = document.createElement('div');
                pagination.className = 'hiscores-pagination';
                
                if (this.currentPage > 0) {
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = '← Previous';
                    prevBtn.addEventListener('click', () => {
                        this.currentPage--;
                        this.loadLeaderboard();
                    });
                    pagination.appendChild(prevBtn);
                }
                
                const pageInfo = document.createElement('span');
                pageInfo.textContent = `Page ${this.currentPage + 1}`;
                pagination.appendChild(pageInfo);
                
                // Only show next button if there might be more data
                if (data.length === this.pageSize) {
                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = 'Next →';
                    nextBtn.addEventListener('click', () => {
                        this.currentPage++;
                        this.loadLeaderboard();
                    });
                    pagination.appendChild(nextBtn);
                }
                
                container.appendChild(pagination);
            }
            
            // Get leaderboard title
            getLeaderboardTitle() {
                if (this.currentCategory === 'overall') return 'Overall Hiscores';
                if (this.currentCategory === 'tasks') return 'Tasks Hiscores';
                if (this.currentCategory === 'pets') return 'Pets Hiscores';
                if (this.currentCategory === 'shinyPets') return 'Shiny Pets Hiscores';
                if (this.currentCategory === 'cluesTotal') return 'All Clues Hiscores';
                if (this.currentCategory === 'clueseasy') return 'Easy Clues Hiscores';
                if (this.currentCategory === 'cluesmedium') return 'Medium Clues Hiscores';
                if (this.currentCategory === 'clueshard') return 'Hard Clues Hiscores';
                if (this.currentCategory === 'clueselite') return 'Elite Clues Hiscores';
                if (this.currentCategory === 'cluesmaster') return 'Master Clues Hiscores';
                if (this.currentCategory.startsWith('skill_')) {
                    const skillId = this.currentCategory.replace('skill_', '');
                    const skillsData = window.loadingManager.getData('skills');
                    return `${skillsData[skillId].name} Hiscores`;
                }
                return 'Hiscores';
            }
            
            // Search by username
            async searchByName(username) {
                if (!username) return;
                
                try {
                    if (!window.firebaseManager.functions) {
                        console.error('Firebase Functions not initialized');
                        alert('Firebase Functions not initialized.');
                        return;
                    }

                    const getHiscores = httpsCallable(window.firebaseManager.functions, 'getHiscores');
                    const result = await getHiscores({
                        category: this.currentCategory,
                        searchUsername: username,
                        pageSize: this.pageSize
                    });
                    
                    if (result.data.success && result.data.data.length > 0) {
                        // If a user is found, the server returns the page centered on them
                        // Update current page to match the one returned by the server
                        this.currentPage = result.data.metadata.page || 0;
                        this.displayLeaderboard(result.data.data);
                        
                        // Highlight the searched user
                        setTimeout(() => {
                            const rows = document.querySelectorAll('.hiscores-table tbody tr');
                            rows.forEach(row => {
                                const nameCell = row.cells[1];
                                if (nameCell && nameCell.textContent.toLowerCase() === username.toLowerCase()) {
                                    row.classList.add('hiscores-highlight');
                                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            });
                        }, 100);
                    } else {
                        alert(result.data.message || `Player "${username}" not found in this category.`);
                    }
                } catch (error) {
                    console.error('Failed to search player:', error);
                    alert('Failed to search for player. Please try again.');
                }
            }
            
            // Search by rank
            async searchByRank(rank) {
                if (!rank || rank <= 0) return;

                // Calculate the page the rank falls on
                this.currentPage = Math.floor((rank - 1) / this.pageSize);
                await this.loadLeaderboard();
                
                // Highlight the specific rank
                setTimeout(() => {
                    const rows = document.querySelectorAll('.hiscores-table tbody tr');
                    rows.forEach(row => {
                        const rankCell = row.cells[0];
                        if (parseInt(rankCell.textContent) === rank) {
                            row.classList.add('hiscores-highlight');
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }, 100);
            }
            
            // Show individual player stats - OPTIMIZED VERSION
            async showPlayerStats(username) {
                const container = document.getElementById('hiscores-leaderboard');
                if (!container) return;
                
                container.innerHTML = '<div class="hiscores-loading">Loading player stats...</div>';
                
                try {
                    if (!window.firebaseManager.functions) {
                        console.error('Firebase Functions not initialized');
                        alert('Firebase Functions not initialized.');
                        return;
                    }

                    // ONE call to the new Cloud Function to get the complete profile
                    const getPlayerHiscoresProfile = httpsCallable(window.firebaseManager.functions, 'getPlayerHiscoresProfile');
                    const result = await getPlayerHiscoresProfile({ username: username });
                    
                    if (!result.data.success || !result.data.data) {
                        container.innerHTML = '<div class="hiscores-error">Player not found or profile unavailable</div>';
                        return;
                    }
                    
                    const profile = result.data.data;
                    const skillsData = window.loadingManager.getData('skills');

                    container.innerHTML = '';
                    
                    // Title
                    const title = document.createElement('h2');
                    title.className = 'hiscores-leaderboard-title';
                    title.textContent = `Personal Hiscores for ${username}`;
                    container.appendChild(title);
                    
                    // Skills table
                    const skillsTable = document.createElement('table');
                    skillsTable.className = 'hiscores-table';
                    
                    const skillsHead = document.createElement('thead');
                    skillsHead.innerHTML = '<tr><th>Skill</th><th>Rank</th><th>Level</th><th>XP</th></tr>';
                    skillsTable.appendChild(skillsHead);
                    
                    const skillsBody = document.createElement('tbody');
                    
                    // Overall with icon
                    this.addProfileRow(
                        skillsBody, 
                        'Overall', 
                        'skill_skills', 
                        profile.ranks.overall, 
                        profile.values.totalLevel, 
                        formatNumber(profile.values.totalXp)
                    );

                    // Individual skills with icons
                    for (const skillId of Object.keys(skillsData)) {
                        const category = `skill_${skillId}`;
                        this.addProfileRow(
                            skillsBody,
                            skillsData[skillId].name,
                            category,
                            profile.ranks[category],
                            profile.values[`level_${skillId}`],
                            formatNumber(profile.values[`xp_${skillId}`])
                        );
                    }
                    
                    skillsTable.appendChild(skillsBody);
                    container.appendChild(skillsTable);
                    
                    // Categories table
                    const catTable = document.createElement('table');
                    catTable.className = 'hiscores-table';
                    
                    const catHead = document.createElement('thead');
                    catHead.innerHTML = '<tr><th>Category</th><th>Rank</th><th>Score</th></tr>';
                    catTable.appendChild(catHead);
                    
                    const catBody = document.createElement('tbody');
                    
                    // Tasks with icon
                    this.addProfileRow(
                        catBody, 
                        'Tasks', 
                        'ui_tasks', 
                        profile.ranks.tasks, 
                        profile.values.tasksCompleted
                    );
                    
                    // Pets with icon
                    this.addProfileRow(
                        catBody, 
                        'Pets', 
                        'ui_pets', 
                        profile.ranks.pets, 
                        profile.values.petsTotal
                    );
                    
                    // Shiny Pets with icon
                    this.addProfileRow(
                        catBody, 
                        'Shiny Pets', 
                        'ui_pets_shiny', 
                        profile.ranks.shinyPets, 
                        profile.values.petsShiny
                    );

                    // All Clues with icon
                    this.addProfileRow(
                        catBody, 
                        'All Clues', 
                        'ui_all_clue', 
                        profile.ranks.cluesTotal, 
                        profile.values.cluesTotal
                    );

                    // Individual Clue Tiers
                    const clueTiers = [
                        { id: 'easy', name: 'Easy Clues', icon: 'easy_clue', category: 'clueseasy' },
                        { id: 'medium', name: 'Medium Clues', icon: 'medium_clue', category: 'cluesmedium' },
                        { id: 'hard', name: 'Hard Clues', icon: 'hard_clue', category: 'clueshard' },
                        { id: 'elite', name: 'Elite Clues', icon: 'elite_clue', category: 'clueselite' },
                        { id: 'master', name: 'Master Clues', icon: 'master_clue', category: 'cluesmaster' }
                    ];
                    
                    for (const tier of clueTiers) {
                        const fieldName = `clues${tier.id.charAt(0).toUpperCase() + tier.id.slice(1)}`;
                        let iconKey = `items_${tier.icon}`;
                        this.addProfileRow(
                            catBody,
                            tier.name,
                            iconKey,
                            profile.ranks[tier.category],
                            profile.values[fieldName]
                        );
                    }
                    
                    catTable.appendChild(catBody);
                    container.appendChild(catTable);
                    
                    // Back button
                    const backBtn = document.createElement('button');
                    backBtn.className = 'hiscores-back-btn';
                    backBtn.textContent = '← Back to Leaderboard';
                    backBtn.addEventListener('click', () => {
                        this.loadLeaderboard();
                    });
                    container.appendChild(backBtn);
                    
                } catch (error) {
                    console.error('Failed to load player stats:', error);
                    container.innerHTML = `<div class="hiscores-error">Failed to load player stats: ${error.message}</div>`;
                }
            }

            // Helper for adding rows to player profile tables
            addProfileRow(tbody, label, iconKey, rank, value, xpValue = null) {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.className = 'hiscores-skill-name-cell';

                // Icon handling
                if (iconKey) {
                    const icon = window.loadingManager.getImage(iconKey);
                    if (icon) {
                        const iconImg = document.createElement('img');
                        iconImg.className = 'hiscores-inline-icon';
                        iconImg.src = icon.src;
                        nameCell.appendChild(iconImg);
                    }
                }
                const labelText = document.createElement('span');
                labelText.textContent = label;
                nameCell.appendChild(labelText);
                row.appendChild(nameCell);

                row.innerHTML += `<td>${rank || 'Unranked'}</td>`;
                if (xpValue !== null) { // For skills (Level and XP)
                    row.innerHTML += `<td>${value}</td><td>${xpValue}</td>`;
                } else { // For categories (Score)
                    row.innerHTML += `<td>${formatNumber(value || 0)}</td>`;
                }
                tbody.appendChild(row);
            }
            
            // Compare two users - OPTIMIZED VERSION
            async compareUsersDisplay(user1, user2) {
                if (!user1 || !user2) {
                    alert('Please enter two usernames to compare');
                    return;
                }
                
                const container = document.getElementById('hiscores-leaderboard');
                if (!container) return;
                
                container.innerHTML = '<div class="hiscores-loading">Loading comparison...</div>';
                
                try {
                    if (!window.firebaseManager.functions) {
                        console.error('Firebase Functions not initialized');
                        alert('Firebase Functions not initialized.');
                        return;
                    }

                    // ONE call to the new Cloud Function to get both complete profiles
                    const comparePlayersHiscores = httpsCallable(window.firebaseManager.functions, 'comparePlayersHiscores');
                    const result = await comparePlayersHiscores({ username1: user1, username2: user2 });
                    
                    if (!result.data.success || !result.data.data) {
                        container.innerHTML = '<div class="hiscores-error">One or both players not found for comparison.</div>';
                        return;
                    }

                    const profile1 = result.data.data.player1;
                    const profile2 = result.data.data.player2;
                    const skillsData = window.loadingManager.getData('skills');
                    
                    container.innerHTML = '';
                    
                    // Title
                    const title = document.createElement('h2');
                    title.className = 'hiscores-leaderboard-title';
                    title.textContent = `Comparing ${user1} vs ${user2}`;
                    container.appendChild(title);
                    
                    // Skills comparison table
                    const skillsTable = document.createElement('table');
                    skillsTable.className = 'hiscores-compare-table';
                    
                    const skillsHead = document.createElement('thead');
                    skillsHead.innerHTML = `
                        <tr>
                            <th>Skill</th>
                            <th colspan="2">${profile1.username}</th>
                            <th colspan="2">${profile2.username}</th>
                            <th>Winner</th>
                        </tr>
                        <tr class="hiscores-subheader">
                            <th></th>
                            <th>Rank</th>
                            <th>Level</th>
                            <th>Rank</th>
                            <th>Level</th>
                            <th></th>
                        </tr>
                    `;
                    skillsTable.appendChild(skillsHead);
                    
                    const skillsBody = document.createElement('tbody');
                    
                    // Overall comparison with icon
                    this.addCompareRowWithRank(
                        skillsBody, 
                        'Overall', 
                        'skill_skills',
                        profile1.ranks.overall, profile1.values.totalLevel,
                        profile2.ranks.overall, profile2.values.totalLevel,
                        profile1.values.totalXp, profile2.values.totalXp
                    );
                    
                    // Individual skills comparison with icons
                    for (const skillId of Object.keys(skillsData)) {
                        const category = `skill_${skillId}`;
                        this.addCompareRowWithRank(
                            skillsBody,
                            skillsData[skillId].name,
                            category,
                            profile1.ranks[category], profile1.values[`level_${skillId}`],
                            profile2.ranks[category], profile2.values[`level_${skillId}`],
                            profile1.values[`xp_${skillId}`], profile2.values[`xp_${skillId}`]
                        );
                    }
                    
                    skillsTable.appendChild(skillsBody);
                    container.appendChild(skillsTable);
                    
                    // Categories comparison table
                    const catTable = document.createElement('table');
                    catTable.className = 'hiscores-compare-table';
                    catTable.style.marginTop = '20px';
                    
                    const catHead = document.createElement('thead');
                    catHead.innerHTML = `
                        <tr>
                            <th>Category</th>
                            <th colspan="2">${profile1.username}</th>
                            <th colspan="2">${profile2.username}</th>
                            <th>Winner</th>
                        </tr>
                        <tr class="hiscores-subheader">
                            <th></th>
                            <th>Rank</th>
                            <th>Score</th>
                            <th>Rank</th>
                            <th>Score</th>
                            <th></th>
                        </tr>
                    `;
                    catTable.appendChild(catHead);
                    
                    const catBody = document.createElement('tbody');
                    
                    // Tasks comparison
                    this.addCompareRowWithRank(
                        catBody,
                        'Tasks',
                        'ui_tasks',
                        profile1.ranks.tasks, profile1.values.tasksCompleted,
                        profile2.ranks.tasks, profile2.values.tasksCompleted
                    );
                    
                    // Pets comparison
                    this.addCompareRowWithRank(
                        catBody,
                        'Pets',
                        'ui_pets',
                        profile1.ranks.pets, profile1.values.petsTotal,
                        profile2.ranks.pets, profile2.values.petsTotal
                    );
                    
                    // Shiny Pets comparison
                    this.addCompareRowWithRank(
                        catBody,
                        'Shiny Pets',
                        'ui_pets_shiny',
                        profile1.ranks.shinyPets, profile1.values.petsShiny,
                        profile2.ranks.shinyPets, profile2.values.petsShiny
                    );

                    // All Clues comparison
                    this.addCompareRowWithRank(
                        catBody,
                        'All Clues',
                        'ui_all_clue',
                        profile1.ranks.cluesTotal, profile1.values.cluesTotal,
                        profile2.ranks.cluesTotal, profile2.values.cluesTotal
                    );

                    // Individual Clue Tier comparisons
                    const clueTiers = [
                        { id: 'easy', name: 'Easy Clues', icon: 'easy_clue', category: 'clueseasy' },
                        { id: 'medium', name: 'Medium Clues', icon: 'medium_clue', category: 'cluesmedium' },
                        { id: 'hard', name: 'Hard Clues', icon: 'hard_clue', category: 'clueshard' },
                        { id: 'elite', name: 'Elite Clues', icon: 'elite_clue', category: 'clueselite' },
                        { id: 'master', name: 'Master Clues', icon: 'master_clue', category: 'cluesmaster' }
                    ];
                    
                    for (const tier of clueTiers) {
                        const fieldName = `clues${tier.id.charAt(0).toUpperCase() + tier.id.slice(1)}`;
                        let iconKey = `items_${tier.icon}`;
                        
                        this.addCompareRowWithRank(
                            catBody,
                            tier.name,
                            iconKey,
                            profile1.ranks[tier.category], profile1.values[fieldName],
                            profile2.ranks[tier.category], profile2.values[fieldName]
                        );
                    }
                    
                    catTable.appendChild(catBody);
                    container.appendChild(catTable);
                    
                    // Back button
                    const backBtn = document.createElement('button');
                    backBtn.className = 'hiscores-back-btn';
                    backBtn.textContent = '← Back to Leaderboard';
                    backBtn.addEventListener('click', () => {
                        this.loadLeaderboard();
                    });
                    container.appendChild(backBtn);
                    
                } catch (error) {
                    console.error('Failed to compare users:', error);
                    container.innerHTML = `<div class="hiscores-error">Failed to compare users: ${error.message}</div>`;
                }
            }

            // Helper method for comparison rows with tie-breaking
            async addCompareRowWithRank(tbody, label, iconKey, rank1, value1, rank2, value2, tieBreakerValue1 = 0, tieBreakerValue2 = 0) {
                const row = document.createElement('tr');
                
                // Name cell with icon
                const labelCell = document.createElement('td');
                labelCell.className = 'hiscores-skill-name-cell';
                
                if (iconKey) {
                    const icon = window.loadingManager.getImage(iconKey);
                    if (icon) {
                        const iconImg = document.createElement('img');
                        iconImg.className = 'hiscores-inline-icon';
                        iconImg.src = icon.src;
                        labelCell.appendChild(iconImg);
                    }
                }
                const labelText = document.createElement('span');
                labelText.textContent = label;
                labelCell.appendChild(labelText);
                
                // User 1 data
                const rank1Cell = document.createElement('td');
                rank1Cell.className = 'hiscores-compare-rank';
                rank1Cell.textContent = rank1 || 'Unranked';
                
                const value1Formatted = typeof value1 === 'number' && value1 > 10000 ? formatNumber(value1) : value1;
                const value1Cell = document.createElement('td');
                value1Cell.className = 'hiscores-compare-value';
                value1Cell.textContent = value1Formatted || '0';
                
                // User 2 data
                const rank2Cell = document.createElement('td');
                rank2Cell.className = 'hiscores-compare-rank';
                rank2Cell.textContent = rank2 || 'Unranked';
                
                const value2Formatted = typeof value2 === 'number' && value2 > 10000 ? formatNumber(value2) : value2;
                const value2Cell = document.createElement('td');
                value2Cell.className = 'hiscores-compare-value';
                value2Cell.textContent = value2Formatted || '0';
                
                // Winner cell
                const winnerCell = document.createElement('td');
                winnerCell.className = 'hiscores-compare-winner';
                
                // Determine winner (lower rank number is better, unless it's "Unranked")
                const rank1Num = (rank1 === 'Unranked' || rank1 === undefined || rank1 === null) ? Infinity : parseInt(rank1);
                const rank2Num = (rank2 === 'Unranked' || rank2 === undefined || rank2 === null) ? Infinity : parseInt(rank2);
                
                // Use a more robust comparison that considers value and tie-breaker (like XP for levels)
                let winnerIndicator = '=';
                let color1 = ''; // Default
                let color2 = ''; // Default

                if (rank1Num < rank2Num) {
                    winnerIndicator = '←';
                    color1 = '#2ecc71'; // Green for winner
                    color2 = '#e74c3c'; // Red for loser
                } else if (rank2Num < rank1Num) {
                    winnerIndicator = '→';
                    color1 = '#e74c3c';
                    color2 = '#2ecc71';
                } else if (rank1Num !== Infinity && value1 !== undefined && value2 !== undefined) {
                     // If ranks are tied, use value (level/score). Higher is better.
                    if (value1 > value2) {
                        winnerIndicator = '←';
                        color1 = '#2ecc71';
                        color2 = '#e74c3c';
                    } else if (value2 > value1) {
                        winnerIndicator = '→';
                        color1 = '#e74c3c';
                        color2 = '#2ecc71';
                    } else if (tieBreakerValue1 !== undefined && tieBreakerValue2 !== undefined) {
                         // If value also tied, use tieBreakerValue (XP). Higher is better.
                        if (tieBreakerValue1 > tieBreakerValue2) {
                            winnerIndicator = '←';
                            color1 = '#2ecc71';
                            color2 = '#e74c3c';
                        } else if (tieBreakerValue2 > tieBreakerValue1) {
                            winnerIndicator = '→';
                            color1 = '#e74c3c';
                            color2 = '#2ecc71';
                        }
                    }
                }

                winnerCell.textContent = winnerIndicator;
                winnerCell.style.color = (winnerIndicator === '=') ? '#f39c12' : '#2ecc71'; // Gold for tie, Green for winner

                rank1Cell.style.color = color1;
                value1Cell.style.color = color1;
                rank2Cell.style.color = color2;
                value2Cell.style.color = color2;
                
                row.appendChild(labelCell);
                row.appendChild(rank1Cell);
                row.appendChild(value1Cell);
                row.appendChild(rank2Cell);
                row.appendChild(value2Cell);
                row.appendChild(winnerCell);
                
                tbody.appendChild(row);
            }
        }

        // Create global instance
        window.hiScoresManager = new HiScoresManager();

        // Initialize when ready
        window.addEventListener('DOMContentLoaded', async () => {
            // Show loading
            const loading = document.getElementById('loading-overlay');
            if (loading) loading.style.display = 'flex';
            
            // Load all assets first
            await loadingManager.loadAll();
            
            // Hide loading
            if (loading) loading.style.display = 'none';
            
            // Initialize and open hiscores
            hiScoresManager.initialize();
            hiScoresManager.open();
        });
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading Screen */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
        }

        .loading-content h2 {
            color: #f39c12;
            margin-bottom: 20px;
        }

        .loading-spinner {
            border: 3px solid #333;
            border-top: 3px solid #f39c12;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hiscores Modal */
        .hiscores-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .hiscores-content {
            background: #2c2416;
            border: 2px solid #5a4a3a;
            border-radius: 5px;
            width: 90%;
            max-width: 1400px;
            height: 90%;
            max-height: 900px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .hiscores-layout {
            display: flex;
            height: 100%;
            padding: 20px;
            gap: 20px;
            font-size: 14px;
        }

        .hiscores-categories {
            width: 200px;
            background: #1a1611;
            border: 1px solid #3a3025;
            padding: 10px;
            overflow-y: auto;
        }

        .hiscores-leaderboard {
            flex: 1;
            background: #1a1611;
            border: 1px solid #3a3025;
            padding: 20px;
            overflow-y: auto;
        }

        .hiscores-controls {
            width: 250px;
            background: #1a1611;
            border: 1px solid #3a3025;
            padding: 10px;
        }

        .hiscores-title {
            color: #f39c12;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .hiscores-category-item {
            padding: 8px;
            margin: 2px 0;
            cursor: pointer;
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 5px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .hiscores-category-item:hover {
            background: #2a2015;
        }

        .hiscores-category-item.active {
            background: #3a2520;
            color: #f39c12;
        }

        .category-icon {
            width: 20px;
            height: 20px;
        }

        .hiscores-leaderboard-title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .hiscores-title-icon {
            width: 32px;
            height: 32px;
        }

        .hiscores-leaderboard-title {
            color: #f39c12;
            text-align: center;
            font-size: 24px;
        }

        .hiscores-table {
            width: 100%;
            border-collapse: collapse;
            color: #ccc;
        }

        .hiscores-table th {
            background: #2a2015;
            padding: 10px;
            text-align: left;
            color: #f39c12;
        }

        .hiscores-table td {
            padding: 8px;
            border-bottom: 1px solid #2a2015;
        }

        .hiscores-table tr:hover {
            background: #2a2015;
        }

        .hiscores-own-rank {
            background: #3a2520;
        }

        .hiscores-highlight {
            background: #4a3530 !important;
        }

        .hiscores-name {
            color: #5DADE2;
            cursor: pointer;
        }

        .hiscores-name:hover {
            text-decoration: underline;
        }

        .hiscores-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .hiscores-pagination button {
            padding: 5px 15px;
            background: #3a2520;
            border: 1px solid #5a4a3a;
            color: #ccc;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .hiscores-pagination button:hover {
            background: #4a3530;
        }

        .hiscores-search-section {
            margin-bottom: 20px;
        }

        .hiscores-search-section label {
            display: block;
            color: #f39c12;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .hiscores-search-input {
            width: 100%;
            padding: 5px;
            background: #2a2015;
            border: 1px solid #3a3025;
            color: #ccc;
            margin-bottom: 5px;
            border-radius: 3px;
        }

        .hiscores-search-btn {
            width: 100%;
            padding: 5px;
            background: #3a2520;
            border: 1px solid #5a4a3a;
            color: #ccc;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .hiscores-search-btn:hover {
            background: #4a3530;
        }

        .hiscores-your-rank-btn {
            width: 100%;
            padding: 10px;
            background: #f39c12;
            border: none;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .hiscores-your-rank-btn:hover {
            background: #e67e22;
        }

        .hiscores-back-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: #3a2520;
            border: 1px solid #5a4a3a;
            color: #ccc;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .hiscores-back-btn:hover {
            background: #4a3530;
        }

        .hiscores-skill-name-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hiscores-inline-icon {
            width: 20px;
            height: 20px;
        }

        .hiscores-compare-table {
            width: 100%;
            border-collapse: collapse;
            color: #ccc;
            margin-bottom: 20px;
        }

        .hiscores-compare-table th {
            background: #2a2015;
            padding: 10px;
            text-align: left;
            color: #f39c12;
            font-size: 16px;
        }

        .hiscores-subheader th {
            background: #221a10;
            font-size: 14px;
            color: #999;
            padding: 5px 10px;
        }

        .hiscores-compare-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #2a2015;
            font-size: 14px;
        }

        .hiscores-compare-rank {
            font-weight: bold;
            min-width: 60px;
        }

        .hiscores-compare-value {
            min-width: 80px;
        }

        .hiscores-compare-winner {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        .hiscores-loading,
        .hiscores-error {
            text-align: center;
            padding: 50px;
            color: #ccc;
            font-size: 18px;
        }

        .modal-close-x {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 3000;
            font-weight: bold;
        }

        .modal-close-x:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-overlay">
        <div class="loading-content">
            <h2>Loading Hiscores...</h2>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Hiscores Modal -->
    <div id="hiscores-modal" class="hiscores-modal">
        <div class="hiscores-content">
            <button id="hiscores-close-x" class="modal-close-x">×</button>
            
            <div class="hiscores-layout">
                <!-- Categories -->
                <div class="hiscores-categories" id="hiscores-categories">
                    <!-- Generated by JavaScript -->
                </div>
                
                <!-- Leaderboard -->
                <div class="hiscores-leaderboard" id="hiscores-leaderboard">
                    <div class="hiscores-loading">Loading...</div>
                </div>
                
                <!-- Controls -->
                <div class="hiscores-controls" id="hiscores-controls">
                    <!-- Generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
